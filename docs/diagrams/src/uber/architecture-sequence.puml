@startuml Sequence Diagram
!theme plain
autonumber

title Yandex Go Sequence Diagram - Ride Booking Flow

actor "User" as user
participant "Mobile App" as app
participant "API Gateway" as gateway

box "Core Services" #WhiteSmoke
    participant "User Service" as user_svc
    participant "Maps & Routing\nService" as maps_svc
    participant "Pricing Service" as pricing_svc
    participant "Dispatch Service" as dispatch_svc
    participant "Payment Service" as payment_svc
    participant "Notification\nService" as notif_svc
end box

box "Data Layer" #LightCyan
    participant "Cache (Redis)" as redis
    database "Operational DB\n(YDB)" as ydb
    queue "Message Broker\n(Kafka)" as kafka
end box

box "External Services" #White
    participant "Yandex Maps" as ext_maps
    participant "Yandex Pay" as ext_pay
end box

== 1. App Initialization & Auth ==
user -> app: Open App
app -> gateway: Validate Session
gateway -> user_svc: Authenticate Token (gRPC)
user_svc -> redis: Check Cached Session
redis --> user_svc: Session Valid
user_svc --> gateway: User Profile Data
gateway --> app: Auth Success

== 2. Price Estimation & Routing (Pre-Ride) ==
user -> app: Enter Destination
app -> gateway: Request Estimate (Coords A to B)

par
    gateway -> maps_svc: Calculate Route & ETA
    maps_svc -> ext_maps: Get Traffic/Route Data
    ext_maps --> maps_svc: Route Details
    maps_svc --> gateway: Route Info
else
    gateway -> pricing_svc: Calculate Fare
    pricing_svc -> ydb: Fetch Tariff Rules
    pricing_svc -> redis: Check Surge/Demand
    pricing_svc --> gateway: Estimated Price
end

gateway --> app: Show Route & Price Options (Economy, Comfort, etc.)

== 3. Ride Booking & Dispatch ==
user -> app: Click "Order Ride"
app -> gateway: Create Order Request
gateway -> dispatch_svc: Initialize Ride
dispatch_svc -> user_svc: Validate Payment Method
user_svc --> dispatch_svc: Payment Method OK

dispatch_svc -> ydb: Create Order Record (Status: SEARCHING)
dispatch_svc -> redis: Find Nearby Drivers (Geospatial)
redis --> dispatch_svc: Candidate Drivers

loop Matching Logic
    dispatch_svc -> dispatch_svc: Algorithm matches Driver
end

dispatch_svc -> ydb: Update Order (Status: ASSIGNED)
dispatch_svc -> kafka: Publish Event: <font color=blue>RideAssigned</font>

kafka -> notif_svc: Consume: <font color=blue>RideAssigned</font>
notif_svc -> app: Push Notification: "Driver Found (Plate 123)"
app -> user: Show Driver on Map

== 4. Ride Completion & Payment ==
note right of dispatch_svc: Ride physically occurs... \nDriver marks "Complete" via Driver App (implied)

dispatch_svc -> payment_svc: Initiate Payment (Ride Cost)
payment_svc -> ydb: Fetch Order Details
payment_svc -> ext_pay: Charge User Card
ext_pay --> payment_svc: Transaction Success

payment_svc -> ydb: Update Payment Status (PAID)
payment_svc -> kafka: Publish Event: <font color=green>PaymentSuccess</font>

kafka -> notif_svc: Consume: <font color=green>PaymentSuccess</font>
notif_svc -> app: Push Notification: "Receipt"
app -> user: Display Receipt & Rate Driver

@enduml